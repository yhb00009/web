(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7393a9d7"],{"0e93":function(t,e,n){"use strict";n("a1cb")},"1d85":function(t,e,n){"use strict";n.r(e);var s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("lemon-imui",{ref:"IMUI",staticClass:"height",attrs:{user:t.user,width:"100%",height:"100%"},on:{"pull-messages":t.handlePullMessages,send:t.send}})},o=[],c=(n("d3b7"),n("25f0"),n("d81d"),n("e9c4"),n("ac1f"),n("5319"),n("4de4"),n("c24f")),a=n("bd2b"),i="/im/";function r(){return Object(a["a"])({url:i+"contact/contacts",method:"post",data:{}})}var u=n("ad66"),d=function(){return(new Date).getTime()},l=function(){return Math.random().toString(36).substr(-8)},f={name:"WebSocket",data:function(){return{user:{},contact:[]}},mounted:function(){this.initUser(),this.initContacts()},destroyed:function(){this.websocketclose()},methods:{initUser:function(){var t=this;Object(c["b"])().then((function(e){var n=e.data,s=n.pkId,o=n.avatar,c=n.username;t.user={id:s,displayName:c,avatar:o},t.initWebSocket()}))},initContacts:function(){var t=this,e=this.$refs.IMUI;r().then((function(n){t.contact=n.data.map((function(t){return t.lastContent=e.lastContentRender({type:"text",content:t.lastContent}),t})),e.initContacts(t.contact)}))},handlePullMessages:function(t,e){var n=[{id:l(),status:"succeed",type:"text",sendTime:t.lastSendTime,content:t.lastContent,toContactId:this.user.id,fromUser:t}];e(n,!0)},send:function(t,e){var n=t.toContactId,s=t.content,o={single:!0,toId:n,message:s};this.websock.send(JSON.stringify(o)),e()},initWebSocket:function(){var t=u["a"].replace("https","ws").replace("http","ws")+"im/websocket/"+this.user.id;this.websock=new WebSocket(t),this.websock.onopen=this.websocketonopen,this.websock.onerror=this.websocketonerror,this.websock.onmessage=this.websocketonmessage,this.websock.onclose=this.websocketclose},websocketonopen:function(){console.log("WebSocket连接成功")},websocketonerror:function(t){console.log("WebSocket连接发生错误",t)},websocketonmessage:function(t){var e=JSON.parse(t.data),n=e.message,s=e.fromId,o=this.contact.filter((function(t){return t["id"]===s}));if(o&&o.length>0){var c=o[0],a=c.id,i=c.displayName,r=c.avatar,u={id:l(),status:"succeed",type:"text",sendTime:d(),content:n,toContactId:s,fromUser:{id:a,displayName:i,avatar:r}},f=this.$refs.IMUI;f.appendMessage(u)}},websocketclose:function(t){console.log("connection closed ("+t.code+")")},evil:function(t){var e=Function;return new e("return "+t)()}}},h=f,b=(n("0e93"),n("2877")),m=Object(b["a"])(h,s,o,!1,null,"5648cc0f",null);e["default"]=m.exports},a1cb:function(t,e,n){}}]);